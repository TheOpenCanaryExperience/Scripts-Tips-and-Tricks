#!/bin/bash

# Source: https://github.com/TheOpenCanaryExperience/Scripts-Tips-and-Tricks
# Credit: Scripts created from instructions to ChatGPT (why not?!)
# Based on: https://github.com/thinkst/opencanary
# Read more: www.toce.ch and www.willigetpwned.com

# Set your source and destination folders
source_folder="$HOME/malware"
destination_folder="$HOME/malware"

# Calculate the previous month in yyyy-mm format
previous_month=$(date -d "last month" +%Y-%m)

# Create the destination folder for the current month
destination_folder_month="$destination_folder/$previous_month"
mkdir -p "$destination_folder_month"

# Move files from the previous month in the source folder to the destination folder
for file in "$source_folder"/*; do
    # Check if the file has the correct timestamp
    if [ -f "$file" ] && [ "$(date -r "$file" +%Y-%m)" == "$previous_month" ]; then
        destination_file="$destination_folder_month/$(basename "$file")"
        
        # Print the destination file for debugging
        echo "Moving $file to $destination_file"
        
        # Perform the move operation using mv
        mv "$file" "$destination_file"
        
        # Check if the move operation was successful
        if [ $? -eq 0 ]; then
            echo "File '$file' moved to '$destination_folder_month/'."
        else
            echo "Error: Failed to move file '$file'."
        fi
    fi
done

# Generate a summary of the number of files moved
moved_files_count=$(find "$destination_folder_month" -maxdepth 1 -type f -not -name ".*" | grep -E -v '/\.$|/\.\.$' | wc -l)
echo "Files moved: $moved_files_count"

# Generate SHA256sum and create a list of hyperlinks to VirusTotal
hash_list=()

for file in "$destination_folder_month"/*; do
    sha256sum_value=$(sha256sum "$file" | awk '{print $1}')
    
    # Check if the hash is already in the list
    if [[ ! " ${hash_list[@]} " =~ " $sha256sum_value " ]]; then
        hash_list+=("$sha256sum_value")
        
        # Debug: Print filename and hash information
        echo "File: $file, Hash: $sha256sum_value"
    fi
done

# Debug: Print hash list
echo "Hash List: ${hash_list[@]}"

# Get the number of unique hashes
unique_hashes_count=${#hash_list[@]}
echo "Unique Hashes: $unique_hashes_count"

# Prepare the message for Discord
discord_message="**Monthly Malware Mover:**
Files Moved: $moved_files_count
Unique Hashes: $unique_hashes_count
Hash List:
${hash_list[@]/#/https://www.virustotal.com/gui/file/}"

# Output the message to Discord using curl
discord_webhook_url="<YOUR_DISCORD_WEBHOOK_URL>"
curl -X POST -H "Content-Type: application/x-www-form-urlencoded" --data-urlencode "content=$discord_message" "$discord_webhook_url"
