#!/bin/bash

# Source: https://github.com/TheOpenCanaryExperience/Scripts-Tips-and-Tricks
# Credit: Scripts created from instructions to ChatGPT (why not?!)
# Based on: https://github.com/thinkst/opencanary
# Read more: www.toce.ch and www.willigetpwned.com

# Function to process samba-audit.log file
process_samba_audit() {
    local current_month="$1"
    local user_variable="$2"
    local samba_audit_file="$3"

    echo "Processing samba-audit.log file for $current_month:"
    grep -E "^$current_month [0-9]{1,2} [0-9]{2}:[0-9]{2}:[0-9]{2} $user_variable smbd_audit:" "$samba_audit_file" | awk -F 'smbd_audit: ' '{print $2}' | awk -F'|' '{print $1, $2}' | sort | uniq -c | awk '{print $2, $3, "(" $1 ")"}'
}

# User-defined variable for processing the samba-audit file
user_variable="your_samba-audit.log_machine_name"

# Source and destination folders
source_folder="$HOME/malware"
destination_folder="$HOME/malware/$(date +'%Y-%m')"

# Get the current month abbreviation (e.g., Dec) and year
current_month=$(date +'%b')
current_year=$(date +'%Y')

# Create the destination folder if it doesn't exist
mkdir -p "$destination_folder"

# Move files based on their timestamps
find "$source_folder" -type f -newermt "$(date +'%Y-%m-01 00:00:00')" ! -newermt "$(date -d '+1 month' +'%Y-%m-01 00:00:00')" -exec mv {} "$destination_folder" \;

# Process samba-audit.log file
samba_audit_file="/var/log/samba-audit.log"

# Extract and count unique values for debugging
if [ -f "$samba_audit_file" ]; then
    summary_text="[OC/Loc]  Malware Summary Month $current_month $current_year:"
    summary_text+="\nFiles Moved: $(find "$destination_folder" -type f | wc -l)"

    # Initialize variables for unique hashes
    unique_hashes_count=0
    unique_hashes_list=""

    while IFS= read -r hash; do
        # Increment unique hash count
        ((unique_hashes_count++))

        # Append to the list of unique hashes
        unique_hashes_list+="https://www.virustotal.com/gui/file/$hash"$'\n'
    done < <(find "$destination_folder" -type f -exec md5sum {} + | awk '{print $1}' | sort -u)

    summary_text+="\nUnique hashes: $unique_hashes_count"
    summary_text+="\nList of unique hashes:"$'\n'"$unique_hashes_list"

    # Save summary to log file
    echo -e "$summary_text" > "$HOME/logs/monthly-malware-mover.log"

    # Output to webhook
    webhook_url="https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"

    # Construct the payload for the webhook with proper formatting
    payload="content=$(cat $HOME/logs/monthly-malware-mover.log | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n')"

    # Display the constructed message
    echo -e "Constructed Message:\n\n$payload\n"

    # Ask for user confirmation before sending
    read -p "Press Enter to send the message, or Ctrl+C to cancel..."

    # Send the payload to the webhook with x-www-form-urlencoded content type
    # Discord doesn't seem to like application/json
    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "$payload" "$webhook_url"

    # Process samba-audit.log
    process_samba_audit "$current_month" "$user_variable" "$samba_audit_file" > "$HOME/logs/samba_audit_summary.log"

    # Output samba audit summary to webhook and log file
    echo -e "\n\nSamba Audit Log Summary:" >> "$HOME/logs/monthly-malware-mover.log"
    cat "$HOME/logs/samba_audit_summary.log" >> "$HOME/logs/monthly-malware-mover.log"

    # Send the samba audit summary payload to the webhook with x-www-form-urlencoded content type
    samba_audit_payload="content=$(cat $HOME/logs/samba_audit_summary.log | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n')"
    curl -X POST -H "Content-Type: application/x-www-form-urlencoded" -d "$samba_audit_payload" "$webhook_url"
else
    echo "Samba-audit.log file not found."
fi
